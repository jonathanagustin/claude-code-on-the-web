#!/bin/bash

# SessionStart hook for Claude Code
# This script runs automatically when a new Claude Code session starts

# Only run in remote (web) environments
if [ "$CLAUDE_CODE_REMOTE" != "true" ]; then
    echo "Running locally, skipping environment setup"
    exit 0
fi

echo "======================================"
echo "Claude Code on the Web Environment"
echo "Kubernetes Research Project"
echo "======================================"
echo ""

# Run the setup script to ensure all tools are installed
if [ -f "tools/setup-claude.sh" ]; then
    echo "Installing development tools..."
    bash tools/setup-claude.sh
    echo ""
fi

# Add CNI bin directory to PATH
export PATH="/opt/cni/bin:$PATH"

echo "======================================"
echo "Starting k3s Control-Plane"
echo "======================================"
echo ""

# Auto-start the production-ready control-plane
if [ -f "tools/quick-start.sh" ]; then
    sudo bash tools/quick-start.sh
else
    echo "⚠️  Quick-start script not found"
    echo ""
    echo "Manual start:"
    echo "  sudo bash solutions/control-plane-native/start-k3s-native.sh"
fi

# Configure environment variables for kubectl
# Check both legacy and current kubeconfig locations
if [ -f "/tmp/k3s-control-plane/kubeconfig.yaml" ]; then
    export KUBECONFIG="/tmp/k3s-control-plane/kubeconfig.yaml"
    KUBECONFIG_LOCATION="/tmp/k3s-control-plane/kubeconfig.yaml"
elif [ -f "/etc/rancher/k3s/k3s.yaml" ]; then
    export KUBECONFIG="/etc/rancher/k3s/k3s.yaml"
    KUBECONFIG_LOCATION="/etc/rancher/k3s/k3s.yaml"
fi

if [ -n "$KUBECONFIG_LOCATION" ]; then
    echo ""
    echo "======================================"
    echo "Environment Ready!"
    echo "======================================"
    echo ""
    echo "✓ k3s control-plane running"
    echo "✓ kubectl configured: $KUBECONFIG_LOCATION"
    echo "✓ Helm available"
    echo ""
    echo "Quick test:"
    echo "  kubectl get namespaces"
    echo "  helm create mychart"
    echo ""
    echo "Research Documentation:"
    echo "  - PROGRESS-SUMMARY.md - Complete findings"
    echo "  - experiments/17-inotify-cgroup-faker/README.md - Latest experiment"
    echo "  - CLAUDE.md - Project overview"
    echo ""
fi

